image: golang

stages:
  - gofmt
  - test
  - sonar

gofmt:
  stage: gofmt
  script:
    - gofmtError=$(gofmt -l $(find . -name '*.go'))
    - if [ ! $gofmtError = "" ]; then
    -   echo "gofmt condition not matched, run \"\$\$gofmt -w \$(find . -name '*.go')\" before any commit."
    -   exit 1
    - fi

tests:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/terraform-ci:latest
  stage: test
  script:
    - cd sewan
    - go test -coverprofile=coverage.out

sonarqube_preview:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/sonar-ci:latest
  stage: sonar
  script:
    - sh /opt/sonar-runner/bin/sonar-runner
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.gitlab.user_token=$SONAR_GITLAB_USERTOKEN
      -Dsonar.login=$SONAR_LOGIN
      -Dsonar.analysis.mode=preview
      -Dsonar.issuesReport.console.enable=true
      -Dsonar.gitlab.commit_sha=$CI_BUILD_REF
      -Dsonar.gitlab.ref_name=$CI_BUILD_REF_NAME
      -Dsonar.gitlab.project_id=$CI_PROJECT_PATH

sonarqube:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/sonar-ci:latest
  stage: sonar
  script:
    - sh /opt/sonar-runner/bin/sonar-runner
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.login=$SONAR_LOGIN
