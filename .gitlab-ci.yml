image: golang


stages:
  - fmtAndUnitTest
  - sonar

# NB about symbolic link : https://redmine.priv.sewan.fr/issues/37334
fmt_and_unit_tests:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/terraform-ci:latest
  stage: fmtAndUnitTest
  before_script:
    - ln -s $CI_PROJECT_DIR $GOPATH/src/gitlab.com/
    - cd $GOPATH/src/gitlab.com/$CI_PROJECT_NAME
  script:
    - make test

sonarqube_preview:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/sonar-ci:latest
  stage: sonar
  script:
    - sh /opt/sonar-runner/bin/sonar-runner
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.gitlab.user_token=$SONAR_GITLAB_USERTOKEN
      -Dsonar.login=$SONAR_LOGIN
      -Dsonar.analysis.mode=preview
      -Dsonar.issuesReport.console.enable=true
      -Dsonar.gitlab.commit_sha=$CI_BUILD_REF
      -Dsonar.gitlab.ref_name=$CI_BUILD_REF_NAME
      -Dsonar.gitlab.project_id=$CI_PROJECT_PATH

sonarqube:
  image: $DOCKER_REGISTRY/sidevops/docker/utils/sonar-ci:latest
  stage: sonar
  script:
    - sh /opt/sonar-runner/bin/sonar-runner
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.login=$SONAR_LOGIN
